# Sales Conversation Simulator

This project simulates sales conversations between an AI-powered seller agent and a persona-based buyer agent using LangGraph, Google Gemini models, and the eBay API. The goal is to analyze sales strategies and agent interactions in a controlled environment.

## Features

*   **LangGraph Simulation:** Orchestrates the multi-turn conversation flow between agents.
*   **Persona-Based Buyers:** Buyer agents adopt personas defined in text files (derived from NMF analysis), influencing their behavior and interests.
*   **Gemini-Powered Agents:** Uses Google Gemini models (via Langchain) for both seller and buyer agent reasoning and responses.
*   **eBay Tool Integration:** Seller agent can use tools to search eBay for products and retrieve item details via the eBay Browse API.
*   **LLM-Based Sale Analysis:** Analyzes conversation history using an LLM to detect if a sale was completed and extract relevant details.
*   **Product Ranking:** Calculates the semantic similarity rank of a sold item within its relevant product category index (CSV file).
*   **Database Logging:** Logs all simulation messages and completed sale records to a PostgreSQL database.
*   **Reporting:** Generates a Markdown report summarizing results across multiple simulation runs, including extracted "sales wisdom" generated by an LLM.

## Project Structure

```
├── core/                 # Core simulation logic (LangGraph, agents, analysis, state)
├── data/
│   └── personas/         # Persona prompts (.txt) and product indices (.csv)
├── models/               # Pre-trained models (e.g., nmf_model.pkl) - *potentially*
├── tests/                # Unit and integration tests
├── tools/                # API interaction wrappers (e.g., ebay_api.py)
├── utils/                # Utility functions (DB connection, persona loading)
├── .env.example          # Example environment variables file
├── .gitignore
├── generate_report.py    # Script to run multiple simulations and generate report
├── requirements.txt      # Python dependencies
├── run_simulation.py     # Script to run a single simulation
├── setup_sales_sim_db.sql # SQL script to set up database schema
├── simulation_report.md  # Example output report (can be gitignored if preferred)
└── README.md             # This file
```

## Setup Instructions

1.  **Clone the Repository:**
    ```bash
    git clone <repository_url>
    cd <repository_directory>
    ```

2.  **Create Virtual Environment:**
    ```bash
    python3 -m venv venv
    source venv/bin/activate  # On Windows use `venv\Scripts\activate`
    ```

3.  **Install Dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Set Up Environment Variables:**
    *   Copy or rename `.env.example` to `.env`.
    *   Fill in the required values in the `.env` file:
        *   `GOOGLE_API_KEY`: Your Google API key for Gemini models.
        *   `DB_NAME`: Name of your PostgreSQL database.
        *   `DB_USER`: Your PostgreSQL username.
        *   `DB_PASSWORD`: Your PostgreSQL password.
        *   `DB_HOST`: Database host (e.g., `localhost`).
        *   `DB_PORT`: Database port (e.g., `5432`).
        *   `EBAY_CLIENT_ID`: Your eBay application Client ID.
        *   `EBAY_CLIENT_SECRET`: Your eBay application Client Secret.
        *   `EBAY_USE_SANDBOX`: (Optional) Set to `True` to use the eBay Sandbox environment, otherwise defaults to Production.

5.  **Set Up Database:**
    *   Ensure you have PostgreSQL installed and running.
    *   Create the database specified in your `.env` file.
    *   Run the setup script against your database:
        ```bash
        psql -U <your_db_user> -d <your_db_name> -a -f setup_sales_sim_db.sql
        ```
        (Enter your password when prompted).

6.  **Persona Data:**
    *   Persona prompt files (`persona_topic_X_prompt_nmf.txt`) are expected in the `data/personas/` directory.
    *   See `data/personas/README.md` for details on how to obtain or generate these files. A placeholder/example may be created automatically.

7.  **Product Index Data:**
    *   Product index files (`persona_topic_X_top_purchases_nmf.csv`), corresponding to the personas, are expected in the `data/personas/` directory.
    *   These CSV files should contain product details, including a description/title column (default: `Title`) and a rank column (default: `Rank`).
    *   These files are likely generated by separate data processing scripts and are not included directly in the repository.

## Running Simulations

### Single Simulation

Use `run_simulation.py` to execute a single conversation for a specific persona.

```bash
# Run with a specific persona (e.g., topic_0)
python run_simulation.py --persona topic_0

# Run with a specific persona and save the full result state to JSON
python run_simulation.py --persona topic_1 --output simulation_results/topic_1_run.json

# Run with the default persona (first one found)
python run_simulation.py
```

### Multiple Runs & Reporting

Use `generate_report.py` to run multiple simulations across various personas, generate sales wisdom using an LLM, calculate metrics, and create a summary report.

```bash
# Run 1 simulation for all available personas (default)
python generate_report.py

# Run 5 simulations for all available personas
python generate_report.py --runs-per-persona 5

# Run 3 simulations each for specific personas
python generate_report.py --runs-per-persona 3 --personas topic_0 topic_5

# Run 1 simulation for all personas, save to custom report file
python generate_report.py --output-file reports/custom_simulation_report.md

# Run using a different Gemini model for wisdom generation (ensure compatibility)
python generate_report.py --wisdom-model gemini-1.5-pro-latest
```

## Dependencies

*   Python 3.8+
*   See `requirements.txt` for specific Python libraries.
*   PostgreSQL Database

## Configuration

*   Primary configuration is handled via the `.env` file.
*   Simulation parameters (number of runs, personas, etc.) can be controlled via command-line arguments for `generate_report.py`.
*   Constants like maximum conversation turns (`MAX_CONVERSATION_TURNS`) are defined in `core/simulation.py`. 